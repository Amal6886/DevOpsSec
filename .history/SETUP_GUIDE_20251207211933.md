# Diet Planner - Setup Guide

## Table of Contents

1. [Pylint Testing](#pylint-testing)
2. [SMTP Email Configuration](#smtp-email-configuration)
3. [Jenkins CI/CD Setup](#jenkins-cicd-setup)
4. [SonarQube Integration](#sonarqube-integration)

---

## Pylint Testing

### Command to Run Pylint and Generate Report

**Important:** First activate your virtual environment and install dependencies!

```bash
# Navigate to project directory
cd "/Users/ziyadmhd/Desktop/codecraftessentials/Diet Planner"

# Activate virtual environment (REQUIRED)
source venv/bin/activate

# Install dependencies if not already installed
pip install -r requirements.txt

# Now run pylint on all Python files (excluding migrations and venv)
pylint --load-plugins=pylint_django \
       --django-settings-module=diet_planner.settings \
       --output-format=text \
       --reports=yes \
       --ignore=migrations,venv \
       accounts/ diet_plans/ products/ orders/ notifications/ diet_planner/ manage.py \
       > pylint_report.txt 2>&1

# Or use the .pylintrc config file (recommended - simpler)
pylint --rcfile=.pylintrc \
       accounts/ diet_plans/ products/ orders/ notifications/ diet_planner/ manage.py \
       > pylint_report.txt 2>&1
```

**Alternative:** If you don't have a virtual environment or want to use system Python:

```bash
# Install pylint globally (not recommended, but works)
pip3 install pylint pylint-django

# Then run the commands above
```

**Troubleshooting:**

- If you get "command not found: pylint" → Activate venv first: `source venv/bin/activate`
- If you get "No module named pylint_django" → Install: `pip install pylint-django`
- If you get Django import errors → Make sure Django is installed: `pip install -r requirements.txt`

### Alternative: Run on Specific Apps Only

```bash
# Test specific app
pylint --rcfile=.pylintrc accounts/ > accounts_pylint_report.txt

# Test without report (just see errors)
pylint --rcfile=.pylintrc accounts/ diet_plans/ products/
```

### Check Pylint Score

```bash
# Get score summary
pylint --rcfile=.pylintrc \
       --reports=yes \
       accounts/ diet_plans/ products/ orders/ notifications/ \
       | grep "rated at"
```

---

## SMTP Email Configuration

### Overview

The application uses Django's built-in SMTP email backend with threading for non-blocking email sending. No Celery or Redis required.

### Step-by-Step Setup

#### 1. Choose an Email Provider

**Option A: Gmail (Recommended for Development)**

- Free, easy to set up
- Requires App Password (not regular password)
- Limit: 500 emails/day for free accounts

**Option B: SendGrid (Recommended for Production)**

- Free tier: 100 emails/day
- Professional email service
- Better deliverability

**Option C: AWS SES (For High Volume)**

- Pay-as-you-go pricing
- Very reliable
- Requires AWS account

#### 2. Gmail Setup (Example)

**Step 1: Enable 2-Factor Authentication**

1. Go to Google Account settings
2. Security → 2-Step Verification
3. Enable it

**Step 2: Generate App Password**

1. Google Account → Security
2. Search for "App passwords"
3. Select "Mail" and "Other (Custom name)"
4. Enter "Diet Planner"
5. Copy the 16-character password

**Step 3: Configure Environment Variables**

Create a `.env` file in project root:

```bash
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=amalpaulgdr@gmail.com
EMAIL_HOST_PASSWORD=doyd tfee bupxhcge
DEFAULT_FROM_EMAIL=amalpaulgdr@gmail.com
```

**Step 4: Install python-decouple (Optional but Recommended)**

```bash
pip install python-decouple
```

**Step 5: Update settings.py (if using python-decouple)**

```python
from decouple import config

EMAIL_HOST = config('EMAIL_HOST', default='smtp.gmail.com')
EMAIL_PORT = config('EMAIL_PORT', default=587, cast=int)
EMAIL_USE_TLS = config('EMAIL_USE_TLS', default=True, cast=bool)
EMAIL_HOST_USER = config('EMAIL_HOST_USER', default='')
EMAIL_HOST_PASSWORD = config('EMAIL_HOST_PASSWORD', default='')
DEFAULT_FROM_EMAIL = config('DEFAULT_FROM_EMAIL', default='noreply@dietplanner.com')
```

#### 3. SendGrid Setup (Production)

**Step 1: Create SendGrid Account**

1. Sign up at https://sendgrid.com
2. Verify your email

**Step 2: Create API Key**

1. Settings → API Keys
2. Create API Key
3. Copy the key (starts with `SG.`)

**Step 3: Configure Environment Variables**

```bash
EMAIL_HOST=smtp.sendgrid.net
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=apikey
EMAIL_HOST_PASSWORD=SG.your-api-key-here
DEFAULT_FROM_EMAIL=your-verified-email@domain.com
```

#### 4. Test Email Configuration

Create a test script `test_email.py`:

```python
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'diet_planner.settings')
django.setup()

from django.core.mail import send_mail

try:
    send_mail(
        'Test Email',
        'This is a test email from Diet Planner.',
        'noreply@dietplanner.com',
        ['your-email@example.com'],
        fail_silently=False,
    )
    print("✅ Email sent successfully!")
except Exception as e:
    print(f"❌ Error: {e}")
```

Run it:

```bash
python test_email.py
```

### How Email System Works

1. **Product Saved**: When admin saves a product (Supplement or ProteinBar)
2. **Signal Triggered**: `post_save` signal fires → `check_stock_level()`
3. **Stock Check**: If `stock_quantity <= threshold`:
   - Creates/updates `StockAlert` record
   - If `alert_sent=False`: Sends email in background thread
   - Sets `alert_sent=True`
4. **Stock Recovery**: If stock goes above threshold:
   - Resets `alert_sent=False` (allows re-alerting later)
5. **Email Sending**: Uses Python `threading.Thread` (non-blocking)

### Email Recipients

- All users with `is_staff=True` receive stock alert emails
- Email is sent to all admin emails simultaneously

---

## Jenkins CI/CD Setup

### Prerequisites

- Jenkins server installed (or Jenkins on Docker)
- Git repository (GitHub, GitLab, Bitbucket)
- Python 3.8+ installed on Jenkins server
- Access to your project repository

### Step-by-Step Setup

#### 1. Install Required Jenkins Plugins

Go to: **Manage Jenkins → Manage Plugins → Available**

Install:

- **Git Plugin** (usually pre-installed)
- **Python Plugin** (for Python builds)
- **HTML Publisher Plugin** (for test reports)
- **Warnings Next Generation Plugin** (for pylint reports)
- **Email Extension Plugin** (for email notifications)

#### 2. Configure Global Tools

**Manage Jenkins → Global Tool Configuration**

**Python:**

- Name: `Python3`
- Install automatically: ✅
- Version: Latest Python 3.x

**Git:**

- Name: `Default`
- Path to Git executable: `git` (or full path)

#### 3. Create New Jenkins Job

1. **New Item** → **Freestyle project** → Name: `Diet-Planner-CI`
2. Click **OK**

#### 4. Configure Source Code Management

**Source Code Management:**

- Select: **Git**
- Repository URL: `https://github.com/yourusername/diet-planner.git`
- Credentials: Add if private repo
- Branches to build: `*/main` or `*/master`

#### 5. Configure Build Triggers

**Build Triggers:**

- ✅ **GitHub hook trigger for GITScm polling** (if using GitHub)
- OR ✅ **Poll SCM**: `H/5 * * * *` (every 5 minutes)
- OR ✅ **Build periodically**: `H 2 * * *` (daily at 2 AM)

#### 6. Configure Build Environment

**Build Environment:**

- ✅ **Delete workspace before build starts**
- ✅ **Provide Node & npm bin/folder to PATH** (if needed)

#### 7. Add Build Steps

**Build → Add build step → Execute shell**

```bash
#!/bin/bash

# Activate virtual environment (if using)
source venv/bin/activate  # or: python3 -m venv venv && source venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Run migrations (if needed)
python manage.py migrate --noinput

# Run Pylint and generate report
pylint --rcfile=.pylintrc \
       --output-format=text \
       --reports=yes \
       accounts/ diet_plans/ products/ orders/ notifications/ diet_planner/ manage.py \
       > pylint_report.txt 2>&1 || true

# Run Django tests
python manage.py test --noinput

# Collect static files (for production)
python manage.py collectstatic --noinput
```

#### 8. Add Post-Build Actions

**Post-build Actions:**

**1. Publish Pylint Results:**

- ✅ **Publish Warnings Next Generation Plugin**
- Report files: `pylint_report.txt`
- Parser: `Pylint`

**2. Publish Test Results:**

- ✅ **Publish JUnit test result report**
- Test report XMLs: `test-results.xml` (if using pytest)

**3. Archive Artifacts:**

- Files to archive: `pylint_report.txt, test-results.xml`

**4. Email Notification:**

- ✅ **Editable Email Notification**
- Project Recipient List: `admin@yourcompany.com`
- Send to: **Developers, Recipient List**
- Triggers: **Failure, Unstable, Success**

#### 9. Save and Test

1. Click **Save**
2. Click **Build Now**
3. Check **Console Output** for errors

### Jenkinsfile (Pipeline as Code) - Alternative Approach

Create `Jenkinsfile` in project root:

```groovy
pipeline {
    agent any

    environment {
        PYTHON_VERSION = '3.9'
        VENV_PATH = "${WORKSPACE}/venv"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup') {
            steps {
                sh '''
                    python3 -m venv venv
                    source venv/bin/activate
                    pip install --upgrade pip
                    pip install -r requirements.txt
                '''
            }
        }

        stage('Lint') {
            steps {
                sh '''
                    source venv/bin/activate
                    pylint --rcfile=.pylintrc \
                           --output-format=text \
                           --reports=yes \
                           accounts/ diet_plans/ products/ orders/ notifications/ \
                           > pylint_report.txt 2>&1 || true
                '''
            }
            post {
                always {
                    publishHTML([
                        reportName: 'Pylint Report',
                        reportDir: '.',
                        reportFiles: 'pylint_report.txt',
                        keepAll: true
                    ])
                }
            }
        }

        stage('Test') {
            steps {
                sh '''
                    source venv/bin/activate
                    python manage.py test --noinput
                '''
            }
        }

        stage('Build') {
            steps {
                sh '''
                    source venv/bin/activate
                    python manage.py collectstatic --noinput
                '''
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'pylint_report.txt', fingerprint: true
        }
        success {
            emailext(
                subject: "✅ Build Success: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: "Build succeeded!",
                to: "admin@yourcompany.com"
            )
        }
        failure {
            emailext(
                subject: "❌ Build Failed: ${env.JOB_NAME} #${env.BUILD_NUMBER}",
                body: "Build failed! Check console output.",
                to: "admin@yourcompany.com"
            )
        }
    }
}
```

---

## SonarQube Integration

### Prerequisites

- SonarQube server running (local or cloud)
- SonarQube project created
- SonarQube token generated

### Step 1: Install SonarQube Scanner

**On Jenkins Server:**

```bash
# Download SonarQube Scanner
wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
unzip sonar-scanner-cli-4.8.0.2856-linux.zip
sudo mv sonar-scanner-4.8.0.2856 /opt/sonar-scanner
```

**Add to PATH:**

```bash
export PATH=$PATH:/opt/sonar-scanner/bin
```

### Step 2: Create sonar-project.properties

Create `sonar-project.properties` in project root:

```properties
sonar.projectKey=diet-planner
sonar.projectName=Diet Planner
sonar.projectVersion=1.0
sonar.sources=accounts,diet_plans,products,orders,notifications
sonar.sourceEncoding=UTF-8
sonar.python.version=3.8,3.9,3.10,3.11,3.12
sonar.exclusions=**/migrations/**,**/venv/**,**/__pycache__/**,**/staticfiles/**,**/media/**
sonar.python.xunit.reportPath=test-results.xml
sonar.python.pylint.reportPath=pylint_report.txt
```

### Step 3: Install SonarQube Plugin in Jenkins

1. **Manage Jenkins → Manage Plugins**
2. Search: **SonarQube Scanner**
3. Install and restart Jenkins

### Step 4: Configure SonarQube Server in Jenkins

1. **Manage Jenkins → Configure System**
2. **SonarQube servers:**
   - Name: `SonarQube`
   - Server URL: `http://localhost:9000` (or your SonarQube URL)
   - Server authentication token: Add your SonarQube token

### Step 5: Add SonarQube Analysis to Jenkins Job

**In your Jenkins job → Build → Add build step:**

```bash
# Generate Pylint report first
pylint --rcfile=.pylintrc \
       --output-format=text \
       --reports=yes \
       accounts/ diet_plans/ products/ orders/ notifications/ \
       > pylint_report.txt 2>&1 || true

# Run SonarQube Scanner
sonar-scanner \
  -Dsonar.projectKey=diet-planner \
  -Dsonar.sources=. \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.login=your-sonarqube-token
```

### Step 6: Add SonarQube Quality Gate Check

**Post-build Actions:**

- ✅ **SonarQube Quality Gate**
- SonarQube installation: `SonarQube`

### Alternative: Using SonarCloud (Cloud-based)

1. Sign up at https://sonarcloud.io
2. Create project
3. Get token
4. Update `sonar-project.properties`:

```properties
sonar.organization=your-org
sonar.host.url=https://sonarcloud.io
```

### SonarQube Analysis Command

```bash
sonar-scanner \
  -Dsonar.projectKey=diet-planner \
  -Dsonar.organization=your-org \
  -Dsonar.sources=accounts,diet_plans,products,orders,notifications \
  -Dsonar.host.url=https://sonarcloud.io \
  -Dsonar.login=your-token
```

---

## Summary

### Quick Commands Reference

**Pylint:**

```bash
pylint --rcfile=.pylintrc accounts/ diet_plans/ products/ orders/ notifications/ > pylint_report.txt
```

**Test Email:**

```bash
python manage.py shell
>>> from django.core.mail import send_mail
>>> send_mail('Test', 'Body', 'from@example.com', ['to@example.com'])
```

**Jenkins Build:**

- Manual: Click "Build Now"
- Automatic: Push to Git (if webhook configured)

**SonarQube:**

```bash
sonar-scanner -Dsonar.login=your-token
```

---

## Troubleshooting

### Email Not Sending

- Check SMTP credentials
- Verify firewall allows port 587
- Check spam folder
- Test with `test_email.py` script

### Jenkins Build Fails

- Check Python path in Jenkins
- Verify virtual environment activation
- Check file permissions
- Review console output

### SonarQube Connection Issues

- Verify SonarQube server is running
- Check token is valid
- Verify network connectivity
- Check SonarQube logs

---

**Last Updated:** 2024-12-07
